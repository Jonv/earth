<p>
  <table id="browser" class="listing">
    <thead>
      <tr>
        <th class="icon"></th>
        <% if @server %>
          <th class="name"><span>Name</span></th>
          <th class="modified"><span>Modified</span></th>
          <th class="user"><span>User</span></th>
        <% else %>
          <th class="name Server"><span>Name</span></th>
        <% end %>
        <th class="size"><span>Size</span></th>
        <th class="bar"></th>
      </tr>
    </thead>
    <tbody>
    <tr class="<%= cycle 'even', 'odd' %>">
      <td class="icon parent">
      <%= if @directory
            if @directory.parent_id
              link_to "", :overwrite_params => {:path => @directory.parent.path}
            else
              link_to "", :overwrite_params => {:server => @server.name, :path => nil}
            end
          else
            if @server
              link_to "", :overwrite_params => {:server => nil, :path => nil}
            end
          end
      %>      </td>
      <td class="name parent" colspan="5">
      <%= if @directory
            if @directory.parent_id
              link_to "..", :overwrite_params => {:path => @directory.parent.path}
            else
              link_to "..", :overwrite_params => {:server => @server.name, :path => nil}
            end
          else
            if @server
              link_to "..", :overwrite_params => {:server => nil, :path => nil}
            end
          end
      %></td>
    </tr>
    <% unless @servers_and_bytes.nil? || @servers_and_bytes.empty? %>
      <% @servers_and_bytes.sort!{|a,b| b[1] <=> a[1]} %>
      <% max_size = @servers_and_bytes[0][1] %>
      <% units = ApplicationHelper::human_units_of max_size %>
      <% for server, size in @servers_and_bytes %>
        <tr class="<%= cycle 'even', 'odd' %>">
          <td class="icon Server"><%= link_to "", :overwrite_params => {:server => server.name, :path => nil} %></td>
          <td class="name Server"><%= link_to "<span>#{server.name}</span>", :overwrite_params => {:server => server.name, :path => nil} %></td>
          <td class="size Server"><%= link_to "<span>#{ApplicationHelper::human_size_in(units, size)} #{units}</span>", :overwrite_params => {:server => server.name, :path => nil} %></td>
          <td class="bar Server"><%= link_to bar(size, max_size, :class => "bar"), :overwrite_params => {:server => server.name, :path => nil} %></td>
        </tr>
      <%  end
      end %>
    <% @directories_and_bytes = [] if @directories_and_bytes.nil? %>
    <% @files = [] if @files.nil? %>
    <% @directories_and_bytes.sort!{|a,b| b[1] <=> a[1]} %>
    <% @files.sort!{|a,b| b.bytes <=> a.bytes} %>
    <% if @directories_and_bytes.empty?
         max_size_directories = 0
       else
         max_size_directories = @directories_and_bytes[0][1]
       end %>
    <% if @files.empty?
         max_size_files = 0
       else
         max_size_files = @files[0].bytes
       end %>
    <% if max_size_directories > max_size_files
         max_size = max_size_directories
       else
         max_size = max_size_files
       end %>
    <% units = ApplicationHelper::human_units_of max_size %>
    <% for directory, size in @directories_and_bytes %>
      <tr class="<%= cycle 'even', 'odd' %>">
        <td class="icon Dir"><%= link_to "", :overwrite_params => {:path => directory.path} %></td>
        <td class="name Dir" colspan="3"><%= link_to directory.name, :overwrite_params => {:path => directory.path} %></td>
        <td class="size Dir"><%= link_to "<span>#{ApplicationHelper::human_size_in(units, size)} #{units}</span>", :overwrite_params => {:path => directory.path} %></td>
        <td class="bar Dir"><%= link_to bar(size, max_size, :class => "bar"), :overwrite_params => {:path => directory.path} %></td>
      </tr>
    <% end %>
    <% @files.each do |file| %>
      <tr class="<%= cycle 'even', 'odd' %>">
        <td class="icon File"><span></span></td>
        <td class="name File"><span><%= file.name %></span></td>
        <td class="modified"><span title="<%=h file.modified %>"><%= distance_of_time_in_words_to_now(file.modified) %> ago</span></td>
        <td class="owner_user"><span><%=h file.user.name %></span></td>
        <td class="size"><span><%= ApplicationHelper::human_size_in(units, file.bytes) %> <%= units %></span></td>
        <td class="bar"><%= bar file.bytes, max_size, :class => "filebar"%></td>
      </tr>
    <% end %>
    </tbody>
  </table>
</p>

<% if @directory %>
<div id="ExportLinks">
  <%= link_to image_tag("excel.png", :size => "20x22", 
      :alt => "Save as CSV", :class => "export_img", :title => "Save as CSV"), :server => @server.name, :path => @directory.path, :format => :csv %>
      
    <%= link_to image_tag("xml.png", :size => "36x14", 
      :alt => "Save as XML", :class => "export_img", :title => "Save as XML"), :server => @server.name, :path => @directory.path, :format => :xml %>  
</div>
<% end %>
